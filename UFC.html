<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UFC 배팅 - 저장 & 엑셀 다운로드</title>
<style>
  :root{--bg:#0f172a;--panel:#111827;--card:#1f2937;--text:#e5e7eb;--accent:#facc15;--muted:#94a3b8;--line:#334155;}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}
  .start-wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .start-box{background:var(--panel);border:1px solid var(--line);border-radius:14px;width:340px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .start-box h2{margin:0 0 16px;text-align:center;color:var(--accent)}
  .field{margin:10px 0}.label{font-size:12px;color:var(--muted);margin-bottom:6px}
  .input{width:100%;background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px;border-radius:10px;outline:none}
  .btn{cursor:pointer;border:none;border-radius:10px;padding:12px 14px;font-weight:800}
  .btn-primary{background:#2563eb;color:#fff} .btn-ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
  .wrap{max-width:1100px;margin:24px auto;padding:12px;display:none}
  h1{margin:0 0 8px;text-align:center;color:var(--accent)}
  .topbar{display:flex;gap:10px;justify-content:space-between;align-items:center;margin-bottom:12px;color:var(--muted)}
  .topbar-right{display:flex;gap:8px} .topbar button{padding:8px 12px;border-radius:8px;cursor:pointer}
  .grid{display:grid;grid-template-columns:1fr 120px 1fr;gap:16px;align-items:stretch}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .panel h3{margin:0 0 10px;font-size:14px;color:var(--muted)}
  select,input[type="number"],input[type="text"]{width:100%;background:var(--card);border:1px solid var(--line);color:var(--text);padding:10px;border-radius:8px;outline:none}
  .fighter-card{margin-top:10px;padding:12px;border:1px dashed var(--line);border-radius:10px;background:var(--card);display:flex;flex-direction:column;gap:8px}
  .fighter-card.active{outline:2px solid #22c55e} .fighter-name{font-size:18px;font-weight:700}
  .sub{color:var(--muted);font-size:12px} .row{display:flex;gap:8px;align-items:center}
  .vs{height:100%;display:flex;align-items:center;justify-content:center;background:var(--panel);border:1px solid var(--line);border-radius:12px;font-size:28px;font-weight:900;letter-spacing:2px}
  .cart{margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .right{text-align:right} .quick{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .chip{padding:6px 10px;border-radius:8px;border:1px solid var(--line);cursor:pointer}
  .footer{margin-top:22px;display:flex;gap:10px} .btn-block{width:100%}
  .tip{margin-top:8px;font-size:12px;color:var(--muted)}
  .export{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>

<!-- 시작 화면 -->
<div class="start-wrap" id="startScreen">
  <div class="start-box">
    <h2>시작하기</h2>
    <div class="field"><div class="label">고유번호(ID)</div><input class="input" id="userId" placeholder="예: 00123"></div>
    <div class="field"><div class="label">이름</div><input class="input" id="userName" placeholder="예: 홍길동"></div>
    <button class="btn btn-primary" style="width:100%" onclick="startApp()">확인</button>
  </div>
</div>

<!-- 메인 -->
<div class="wrap" id="app">
  <h1>UFC 매치 메이커 (2열 선택)</h1>
  <div class="topbar">
    <div id="welcome">-</div>
    <div class="topbar-right">
      <div class="export">
        <input class="input" id="exportCodeInput" placeholder="다운로드 코드" style="width:160px">
        <button class="btn btn-ghost" onclick="exportCSV()">엑셀 다운로드</button>
      </div>
      <button class="btn btn-ghost" onclick="logout()">사용자 변경</button>
    </div>
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="panel" id="leftPanel">
      <h3>왼쪽 선수 선택</h3>
      <select id="leftSelect"></select>
      <div class="fighter-card" id="leftCard" onclick="setBetSide('left')">
        <div class="fighter-name" id="leftName">선수 미선택</div>
        <div class="row">
          <span class="sub">배당</span>
          <input type="number" id="leftOdds" step="0.01" min="1.01" value="1.90" oninput="calc()">
        </div>
      </div>
    </div>
    <div class="vs">VS</div>
    <!-- RIGHT -->
    <div class="panel" id="rightPanel">
      <h3>오른쪽 선수 선택</h3>
      <select id="rightSelect"></select>
      <div class="fighter-card" id="rightCard" onclick="setBetSide('right')">
        <div class="fighter-name" id="rightName">선수 미선택</div>
        <div class="row">
          <span class="sub">배당</span>
          <input type="number" id="rightOdds" step="0.01" min="1.01" value="2.10" oninput="calc()">
        </div>
      </div>
    </div>
  </div>

  <!-- BET CART -->
  <div class="panel" style="margin-top:16px">
    <h3>베팅카트</h3>
    <div class="cart">
      <div><div class="sub">배팅 대상</div><div id="betTarget" style="font-size:18px;font-weight:700">미선택</div></div>
      <div class="right"><div class="sub">배당</div><div id="betOdds" style="font-size:18px;font-weight:700">-</div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div style="flex:1">
        <div class="sub">배팅 금액(가상)</div>
        <input type="number" id="stake" min="1000" step="1000" value="5000" oninput="calc()">
        <div class="quick">
          <span class="chip" onclick="addStake(10000000)">+1천</span>
          <span class="chip" onclick="addStake(100000000)">+1억</span>
          <span class="chip" onclick="addStake(500000000)">+5억</span>
          <span class="chip" onclick="maxStake()">MAX</span>
          <span class="chip" onclick="setStake(0)">CLR</span>
        </div>
      </div>
      <div style="flex:1">
        <div class="sub">예상 당첨금</div>
        <div style="font-size:24px;font-weight:900" id="payout">0원</div>
        <div class="sub" id="implied">암시확률: - %</div>
      </div>
    </div>
    <div class="footer">
      <button class="btn btn-ghost btn-block" onclick="clearAll()">선택 초기화</button>
      <button class="btn btn-primary btn-block" onclick="bet()">BETTING</button>
    </div>
  </div>
</div>

<script>
  const USER_KEY = 'ufc_user';
  const EXPORT_CODE = 'ADMIN123'; 

  function saveUser(id, name){ localStorage.setItem(USER_KEY, JSON.stringify({id, name})); }
  function loadUser(){ try{ const raw = localStorage.getItem(USER_KEY); return raw? JSON.parse(raw): null; }catch(e){ return null; } }
  function logout(){ localStorage.removeItem(USER_KEY); document.getElementById('app').style.display='none'; document.getElementById('startScreen').style.display='flex'; }
  function startApp(){ const id=document.getElementById('userId').value.trim(); const name=document.getElementById('userName').value.trim(); if(!id||!name){ alert('ID와 이름을 모두 입력하세요.'); return; } saveUser(id,name); enterApp({id,name}); }
  function enterApp(user){ document.getElementById('welcome').textContent = `환영합니다, ${user.name}님 (ID: ${user.id})`; document.getElementById('startScreen').style.display='none'; document.getElementById('app').style.display='block'; }

  const fighters = [
    {name:"알렉산더 볼카노프스키", odds:1.62},
    {name:"맥스 할로웨이", odds:2.32},
    {name:"이슬람 마카체프", odds:1.45},
    {name:"찰스 올리베이라", odds:2.85},
    {name:"레온 에드워즈", odds:1.80},
    {name:"코빙턴", odds:2.05},
    {name:"존 존스", odds:1.35},
    {name:"스티페 미오치치", odds:3.10},
  ];

  let betSide=null; let balance=200000; const betHistory=[];

  function initSelects(){['left','right'].forEach(side=>{const sel=document.getElementById(side+'Select'); sel.innerHTML='<option value="">선수 선택…</option>'+fighters.map((f,i)=>`<option value="${i}">${f.name}</option>`).join(''); sel.addEventListener('change',()=>applySelect(side));});}
  function applySelect(side){const sel=document.getElementById(side+'Select'); if(!sel.value)return; const f=fighters[+sel.value]; document.getElementById(side+'Name').textContent=f.name; document.getElementById(side+'Odds').value=f.odds.toFixed(2); calc();}
  function setBetSide(side){betSide=side; document.getElementById('leftCard').classList.toggle('active',side==='left'); document.getElementById('rightCard').classList.toggle('active',side==='right'); const name=document.getElementById(side+'Name').textContent||'미선택'; const odds=+document.getElementById(side+'Odds').value||0; document.getElementById('betTarget').textContent=name; document.getElementById('betOdds').textContent=odds?odds.toFixed(2):'-'; calc();}
  function addStake(v){const el=document.getElementById('stake'); el.value=(+el.value||0)+v; calc();} function setStake(v){document.getElementById('stake').value=v; calc();} function maxStake(){document.getElementById('stake').value=balance; calc();}
  function calc(){const odds=betSide?+document.getElementById(betSide+'Odds').value||0:0; const stake=+document.getElementById('stake').value||0; const payout=odds?Math.floor(stake*odds):0; document.getElementById('payout').textContent=payout.toLocaleString()+'원'; const prob=odds?(100/odds).toFixed(1):'-'; document.getElementById('implied').textContent=`암시확률: ${prob==='-'?'-':prob+' %'}`;}
  function clearAll(){['left','right'].forEach(side=>{document.getElementById(side+'Select').value=''; document.getElementById(side+'Name').textContent='선수 미선택'; document.getElementById(side+'Odds').value=side==='left'?1.90:2.10; document.getElementById(side+'Card').classList.remove('active');}); betSide=null; document.getElementById('betTarget').textContent='미선택'; document.getElementById('betOdds').textContent='-'; document.getElementById('stake').value=5000; calc();}
  function bet(){ if(!betSide){alert('배팅 대상을 선택하세요'); return;} const user=loadUser()||{id:'-',name:'-'}; const leftName=document.getElementById('leftName').textContent; const rightName=document.getElementById('rightName').textContent; const name=document.getElementById(betSide+'Name').textContent; const odds=+document.getElementById(betSide+'Odds').value||0; const stake=+document.getElementById('stake').value||0; if(stake<=0){alert('배팅 금액을 입력하세요'); return;} const payout=stake*odds; const now=new Date(); const timeKR=now.toLocaleString('ko-KR',{timeZone:'Asia/Seoul',hour12:false}); betHistory.push({time_kr:timeKR,time_iso:now.toISOString(),user_id:user.id,user_name:user.name,side:betSide,selection:name,left:leftName,right:rightName,odds:odds,stake:stake,expected_payout:Math.round(payout)}); alert(`배팅 완료!\n대상:${name}\n배당:${odds.toFixed(2)}\n배팅금액:${stake.toLocaleString()}원\n예상당첨금:${Math.round(payout).toLocaleString()}원`);}

  // ===== CSV(엑셀) 다운로드 =====
  function exportCSV(){
    const inputCode=document.getElementById('exportCodeInput').value.trim();
    if(inputCode!==EXPORT_CODE){alert('다운로드 코드가 올바르지 않습니다.');return;}
    if(betHistory.length===0){alert('다운로드할 베팅 내역이 없습니다.');return;}
    const rows=[...betHistory].sort((a,b)=>new Date(b.time_iso)-new Date(a.time_iso));
    const header=['time_kr','time_iso','user_id','user_name','side','selection','left','right','odds','stake','expected_payout'];
    const csv=[header.join(',')].concat(rows.map(r=>[r.time_kr,r.time_iso,r.user_id,r.user_name,r.side,r.selection,r.left,r.right,r.odds,r.stake,r.expected_payout].map(escapeCSV).join(','))).join('\r\n');
    // ✅ UTF-8 BOM 추가
    const BOM="\uFEFF"; const blob=new Blob([BOM+csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); const a=document.createElement('a'); a.href=url; a.download=`bet_history_${stamp}.csv`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
  }
  function escapeCSV(val){const s=String(val??''); if(/[",\r\n]/.test(s)){return `"${s.replace(/"/g,'""')}"`;} return s;}

  (function boot(){const user=loadUser(); if(user){enterApp(user);} else{document.getElementById('startScreen').style.display='flex';} initSelects(); calc();})();
</script>
</body>
</html>
